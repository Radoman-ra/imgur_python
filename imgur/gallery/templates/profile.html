<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            background-color: #2f2f2f;
        }
        .navbar-brand {
            color: #fff;
        }
        .card {
            margin-bottom: 20px;
        }
        .card img {
            max-height: 300px;
            object-fit: cover;
        }
        .error {
            color: red;
        }
        .navbar-right {
            margin-left: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="{% url 'home' %}">Imgur Clone</a>
        <div class="navbar-right d-flex align-items-center">
            {% if user.is_authenticated %}
                <form action="{% url 'logout' %}" method="post" class="form-inline d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-light">Log Out</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-light">Log In</a>
                <a href="{% url 'register' %}" class="btn btn-light">Register</a>
            {% endif %}
        </div>
    </nav>

    <div class="container mt-4">
        <h1>My Profile</h1>
        <div class="row">
            {% for image in user_images %}
            <div class="col-md-4">
                <div class="card" onclick="openImageModal({{ image.id }})">
                    <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.title }}">
                    <div class="card-body">
                        <h5 class="card-title">{{ image.title }}</h5>
                        <p class="card-text">{{ image.description }}</p>
                        <p class="card-text">
                            <small class="text-muted">Uploaded on {{ image.uploaded_at }}</small>
                        </p>
                        <p>Votes: <span id="votes-{{ image.id }}">{{ image.upvotes }}-{{ image.downvotes }}</span></p>
                        <button class="btn btn-success" onclick="upvote({{ image.id }})">Upvote</button>
                        <button class="btn btn-danger" onclick="downvote({{ image.id }})">Downvote</button>
                        <p class="error" id="error-{{ image.id }}"></p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" id="modal-content">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function openImageModal(imageId) {
            $.ajax({
                url: "{% url 'image-detail' 0 %}".replace("0", imageId),
                success: function (data) {
                    $("#modal-content").html(data);
                    $("#imageModal").modal("show");
                },
                error: function () {
                    alert("Failed to load image details.");
                }
            });
        }

        function upvote(imageId) {
            $.ajax({
                url: "{% url 'upvote-image' 0 %}".replace("0", imageId),
                method: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (data) {
                    $("#votes-" + imageId).text(data.upvotes + "-" + data.downvotes);
                    $("#error-" + imageId).text("");
                },
                error: function (xhr) {
                    $("#error-" + imageId).text(xhr.responseJSON.error);
                }
            });
        }

        function downvote(imageId) {
            $.ajax({
                url: "{% url 'downvote-image' 0 %}".replace("0", imageId),
                method: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (data) {
                    $("#votes-" + imageId).text(data.upvotes + "-" + data.downvotes);
                    $("#error-" + imageId).text("");
                },
                error: function (xhr) {
                    $("#error-" + imageId).text(xhr.responseJSON.error);
                }
            });
        }
    </script>
</body>
</html>
